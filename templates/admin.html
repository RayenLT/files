<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Permanent Link Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0px auto;
            padding: 15px;
            background-color: rgb(245, 245, 245);
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: rgba(0, 0, 0, 0.1) 0px 2px 10px;
        }

        h1 {
            color: rgb(51, 51, 51);
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.8rem;
        }

        .stats {
            background: rgb(227, 242, 253);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: rgb(25, 118, 210);
        }

        .bulk-actions {
            background: rgb(250, 250, 250);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid rgb(224, 224, 224);
        }

        .bulk-actions h3 {
            margin: 0 0 15px 0;
            color: rgb(51, 51, 51);
            font-size: 1.1rem;
        }

        .bulk-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .select-all-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .select-all-container input[type="checkbox"] {
            transform: scale(1.2);
        }

        .bulk-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }

        .select-all-btn {
            background-color: rgb(76, 175, 80);
            color: white;
        }

        .select-all-btn:hover {
            background-color: rgb(56, 142, 60);
        }

        .delete-selected-btn {
            background-color: rgb(255, 152, 0);
            color: white;
        }

        .delete-selected-btn:hover {
            background-color: rgb(245, 124, 0);
        }

        .delete-selected-btn:disabled {
            background-color: rgb(189, 189, 189);
            cursor: not-allowed;
        }

        .delete-all-btn {
            background-color: rgb(244, 67, 54);
            color: white;
        }

        .delete-all-btn:hover {
            background-color: rgb(211, 47, 47);
        }

        .selected-count {
            color: rgb(102, 102, 102);
            font-size: 14px;
            margin-left: auto;
        }

        .link-item {
            background: rgb(249, 249, 249);
            padding: 15px;
            margin: 15px 0px;
            border-radius: 8px;
            border-left: 4px solid rgb(33, 150, 243);
            display: flex;
            align-items: flex-start;
            transition: all 0.2s ease;
        }

        .link-item.selected {
            background: rgb(227, 242, 253);
            border-left-color: rgb(25, 118, 210);
        }

        .link-checkbox {
            margin-right: 15px;
            margin-top: 5px;
            transform: scale(1.2);
        }

        .link-info {
            flex-grow: 1;
            min-width: 0px;
        }

        .link-id {
            font-weight: bold;
            font-size: 18px;
            color: rgb(51, 51, 51);
            margin-bottom: 5px;
            word-break: break-word;
        }

        .link-details {
            color: rgb(102, 102, 102);
            font-size: 14px;
            margin: 5px 0px;
        }

        .link-details a {
            word-break: break-all;
        }

        .link-url {
            color: rgb(85, 85, 85);
            font-size: 14px;
            word-break: break-all;
            margin: 5px 0px;
        }

        .edit-btn {
            background-color: rgb(255, 152, 0);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 15px;
            white-space: nowrap;
            touch-action: manipulation;
        }

        .edit-btn:hover {
            background-color: rgb(245, 124, 0);
        }

        .delete-btn {
            background-color: rgb(244, 67, 54);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 15px;
            white-space: nowrap;
            touch-action: manipulation;
        }

        .delete-btn:hover {
            background-color: rgb(211, 47, 47);
        }

        .back-link {
            text-align: center;
            margin-top: 25px;
        }

        .back-link a {
            color: rgb(76, 175, 80);
            text-decoration: none;
            font-weight: bold;
        }

        .back-link a:hover {
            text-decoration: underline;
        }

        .no-links {
            text-align: center;
            color: rgb(102, 102, 102);
            font-style: italic;
            padding: 30px;
        }

        .file-info {
            font-size: 12px;
            color: rgb(136, 136, 136);
            margin-top: 5px;
        }

        .url-short, .url-full {
            cursor: pointer;
            color: rgb(25, 118, 210);
        }

        .url-short:hover, .url-full:hover {
            text-decoration: underline;
        }

        /* Loading spinner */
        .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: none;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
            text-align: center;
        }

        .modal-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .modal-confirm {
            background-color: rgb(244, 67, 54);
            color: white;
        }

        .modal-cancel {
            background-color: rgb(158, 158, 158);
            color: white;
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 15px; }
            h1 { font-size: 1.5rem; margin-bottom: 20px; }

            .bulk-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .bulk-btn {
                width: 100%;
                padding: 12px;
            }

            .selected-count {
                margin-left: 0;
                text-align: center;
            }

            .link-item {
                flex-direction: column;
                align-items: stretch;
                padding: 12px;
            }

            .link-checkbox {
                margin-right: 0;
                margin-bottom: 10px;
                align-self: flex-start;
            }

            .link-id { font-size: 16px; }
            .link-details { font-size: 13px; margin: 8px 0px; }
            .link-url { font-size: 13px; }
            .edit-btn, .delete-btn {
                margin-left: 0px;
                margin-top: 12px;
                padding: 12px 20px;
                width: 100%;
            }
            .stats { padding: 12px; margin-bottom: 20px; }
            .stat-number { font-size: 1.5em; }
            .file-info { font-size: 11px; }
        }

        @media (max-width: 480px) {
            .container { padding: 12px; border-radius: 5px; }
            h1 { font-size: 1.3rem; }
            .link-item { padding: 10px; margin: 10px 0px; }
            .link-id { font-size: 15px; }
            .link-details { font-size: 12px; }
            .link-url { font-size: 12px; }
            .edit-btn, .delete-btn { padding: 10px 15px; font-size: 13px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Admin Panel</h1>

        <div class="stats">
            <div class="stat-number" id="totalLinks">{{ links|length }}</div>
            <div>Total Links Created</div>
        </div>

        {% if links %}
            <div class="bulk-actions">
                <h3>Bulk Operations</h3>
                <div class="bulk-controls">
                    <div class="select-all-container">
                        <input type="checkbox" id="selectAllCheckbox">
                        <label for="selectAllCheckbox">Select All</label>
                    </div>
                    <button class="bulk-btn delete-selected-btn" id="deleteSelectedBtn" disabled>
                        Delete Selected
                        <span class="spinner" id="deleteSelectedSpinner"></span>
                    </button>
                    <button class="bulk-btn delete-all-btn" id="deleteAllBtn">
                        Delete All
                        <span class="spinner" id="deleteAllSpinner"></span>
                    </button>
                    <div class="selected-count" id="selectedCount">0 selected</div>
                </div>
            </div>

            <div id="linksContainer">
                {% for link_id, link_data in links.items() %}
                <div class="link-item" data-link-id="{{ link_id }}">
                    <input type="checkbox" class="link-checkbox" data-link-id="{{ link_id }}">
                    <div class="link-info">
                        <div class="link-id">{{ link_id }}</div>
                        <div class="link-details">
                            <strong>Created:</strong> {{ link_data.created_at }}<br>
                            <strong>Access Count:</strong> {{ link_data.access_count }}<br>
                            <strong>Download Link:</strong> <a href="{{ request.host_url }}download/{{ link_id }}" target="_blank">{{ request.host_url }}download/{{ link_id }}</a>
                        </div>
                        {% if link_data.file_info %}
                        <div class="file-info">
                            <strong>File:</strong> {{ link_data.file_info.filename }}
                            ({{ (link_data.file_info.file_size / 1024 / 1024) | round(2) }} MB)
                        </div>
                        {% endif %}
                        <div class="link-url">
                            <strong>Original URL:</strong>
                            <span class="url-short">{{ link_data.original_url[:50] }}{% if link_data.original_url|length > 50 %}...{% endif %}</span>
                            <span class="url-full" style="display: none;">{{ link_data.original_url }}</span>
                        </div>
                    </div>
                    <button class="edit-btn" data-link-id="{{ link_id }}">Edit</button>
                    <button class="delete-btn" data-link-id="{{ link_id }}">Delete</button>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-links">No links created yet.</div>
        {% endif %}

        <div class="back-link">
            <a href="/">← Back to Link Generator</a>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">Confirm Action</h3>
            <p id="modalMessage">Are you sure you want to proceed?</p>
            <div class="modal-buttons">
                <button class="modal-btn modal-confirm" id="modalConfirm">Confirm</button>
                <button class="modal-btn modal-cancel" id="modalCancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3>Edit Link ID</h3>
            <p>Enter a new custom name for this link:</p>
            <input type="text" id="editLinkId" placeholder="Enter new link ID" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
            <div class="modal-buttons">
                <button class="modal-btn modal-confirm" id="editConfirm">Save</button>
                <button class="modal-btn modal-cancel" id="editCancel">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let selectedLinks = new Set();
        let currentAction = null;
        let currentEditLinkId = null;

        // DOM elements
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        const deleteAllBtn = document.getElementById('deleteAllBtn');
        const selectedCountEl = document.getElementById('selectedCount');
        const totalLinksEl = document.getElementById('totalLinks');
        const linksContainer = document.getElementById('linksContainer');
        const confirmModal = document.getElementById('confirmModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirm = document.getElementById('modalConfirm');
        const modalCancel = document.getElementById('modalCancel');
        const editModal = document.getElementById('editModal');
        const editLinkIdInput = document.getElementById('editLinkId');
        const editConfirm = document.getElementById('editConfirm');
        const editCancel = document.getElementById('editCancel');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            updateUI();
        });

        function initializeEventListeners() {
            // Select all checkbox
            selectAllCheckbox.addEventListener('change', function() {
                const linkCheckboxes = document.querySelectorAll('.link-checkbox');
                linkCheckboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                    updateLinkSelection(checkbox);
                });
                updateSelectedSet();
                updateUI();
            });

            // Individual link checkboxes
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('link-checkbox')) {
                    updateLinkSelection(e.target);
                    updateSelectedSet();
                    updateUI();
                }
            });

            // Delete selected button
            deleteSelectedBtn.addEventListener('click', function() {
                if (selectedLinks.size === 0) return;

                currentAction = 'deleteSelected';
                modalTitle.textContent = 'Delete Selected Links';
                modalMessage.textContent = `Are you sure you want to delete ${selectedLinks.size} selected link(s)? This action cannot be undone.`;
                confirmModal.style.display = 'block';
            });

            // Delete all button
            deleteAllBtn.addEventListener('click', function() {
                const totalLinks = document.querySelectorAll('.link-item').length;
                if (totalLinks === 0) return;

                currentAction = 'deleteAll';
                modalTitle.textContent = 'Delete All Links';
                modalMessage.textContent = `Are you sure you want to delete ALL ${totalLinks} link(s)? This action cannot be undone.`;
                confirmModal.style.display = 'block';
            });

            // Individual delete buttons
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('delete-btn')) {
                    const linkId = e.target.getAttribute('data-link-id');
                    currentAction = { type: 'deleteSingle', linkId: linkId };
                    modalTitle.textContent = 'Delete Link';
                    modalMessage.textContent = `Are you sure you want to delete the link "${linkId}"? This action cannot be undone.`;
                    confirmModal.style.display = 'block';
                }
            });

            // Individual edit buttons
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('edit-btn')) {
                    const linkId = e.target.getAttribute('data-link-id');
                    currentEditLinkId = linkId;
                    document.getElementById('editLinkId').value = linkId;
                    document.getElementById('editModal').style.display = 'block';
                }
            });

            // Modal buttons
            modalConfirm.addEventListener('click', function() {
                confirmModal.style.display = 'none';
                executeAction();
            });

            modalCancel.addEventListener('click', function() {
                confirmModal.style.display = 'none';
                currentAction = null;
            });

            // Edit modal buttons
            editConfirm.addEventListener('click', function() {
                const newLinkId = editLinkIdInput.value.trim();
                if (newLinkId && currentEditLinkId) {
                    editLinkId(currentEditLinkId, newLinkId);
                }
                editModal.style.display = 'none';
                currentEditLinkId = null;
            });

            editCancel.addEventListener('click', function() {
                editModal.style.display = 'none';
                currentEditLinkId = null;
            });

            // Close modal when clicking outside
            window.addEventListener('click', function(e) {
                if (e.target === confirmModal) {
                    confirmModal.style.display = 'none';
                    currentAction = null;
                } else if (e.target === editModal) {
                    editModal.style.display = 'none';
                    currentEditLinkId = null;
                }
            });

            // URL toggle functionality
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('url-short')) {
                    const fullUrl = e.target.nextElementSibling;
                    e.target.style.display = 'none';
                    fullUrl.style.display = 'inline';
                } else if (e.target.classList.contains('url-full')) {
                    const shortUrl = e.target.previousElementSibling;
                    e.target.style.display = 'none';
                    shortUrl.style.display = 'inline';
                }
            });
        }

        function updateLinkSelection(checkbox) {
            const linkItem = checkbox.closest('.link-item');
            if (checkbox.checked) {
                linkItem.classList.add('selected');
            } else {
                linkItem.classList.remove('selected');
            }
        }

        function updateSelectedSet() {
            selectedLinks.clear();
            const checkedBoxes = document.querySelectorAll('.link-checkbox:checked');
            checkedBoxes.forEach(checkbox => {
                selectedLinks.add(checkbox.getAttribute('data-link-id'));
            });

            // Update select all checkbox state
            const totalCheckboxes = document.querySelectorAll('.link-checkbox').length;
            const checkedCheckboxes = checkedBoxes.length;

            if (checkedCheckboxes === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (checkedCheckboxes === totalCheckboxes) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
                selectAllCheckbox.checked = false;
            }
        }

        function updateUI() {
            // Update selected count
            selectedCountEl.textContent = `${selectedLinks.size} selected`;

            // Enable/disable delete selected button
            deleteSelectedBtn.disabled = selectedLinks.size === 0;

            // Update total links count
            const totalLinks = document.querySelectorAll('.link-item').length;
            totalLinksEl.textContent = totalLinks;
        }

        async function executeAction() {
            try {
                if (currentAction === 'deleteSelected') {
                    await deleteSelectedLinks();
                } else if (currentAction === 'deleteAll') {
                    await deleteAllLinks();
                } else if (currentAction && currentAction.type === 'deleteSingle') {
                    await deleteSingleLink(currentAction.linkId);
                }
            } catch (error) {
                console.error('Action failed:', error);
                alert('Operation failed. Please try again.');
            } finally {
                currentAction = null;
            }
        }

        async function deleteSelectedLinks() {
            const spinner = document.getElementById('deleteSelectedSpinner');
            deleteSelectedBtn.disabled = true;
            spinner.style.display = 'inline-block';

            try {
                const deletePromises = Array.from(selectedLinks).map(linkId =>
                    fetch(`/admin/delete/${linkId}`, { method: 'DELETE' })
                );

                const results = await Promise.allSettled(deletePromises);

                // Remove successfully deleted items from DOM
                results.forEach((result, index) => {
                    const linkId = Array.from(selectedLinks)[index];
                    if (result.status === 'fulfilled' && result.value.ok) {
                        const linkItem = document.querySelector(`[data-link-id="${linkId}"]`);
                        if (linkItem) {
                            linkItem.remove();
                        }
                    }
                });

                // Clear selection and update UI
                selectedLinks.clear();
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
                updateUI();

                // Check for failures
                const failures = results.filter(result => result.status === 'rejected' || !result.value.ok);
                if (failures.length > 0) {
                    alert(`${results.length - failures.length} links deleted successfully. ${failures.length} failed.`);
                } else {
                    alert('All selected links deleted successfully!');
                }

            } finally {
                spinner.style.display = 'none';
                deleteSelectedBtn.disabled = false;
            }
        }

        async function deleteAllLinks() {
            const spinner = document.getElementById('deleteAllSpinner');
            deleteAllBtn.disabled = true;
            spinner.style.display = 'inline-block';

            try {
                const allLinkItems = document.querySelectorAll('.link-item');
                const allLinkIds = Array.from(allLinkItems).map(item => item.getAttribute('data-link-id'));

                const deletePromises = allLinkIds.map(linkId =>
                    fetch(`/admin/delete/${linkId}`, { method: 'DELETE' })
                );

                const results = await Promise.allSettled(deletePromises);

                // Remove successfully deleted items from DOM
                results.forEach((result, index) => {
                    const linkId = allLinkIds[index];
                    if (result.status === 'fulfilled' && result.value.ok) {
                        const linkItem = document.querySelector(`[data-link-id="${linkId}"]`);
                        if (linkItem) {
                            linkItem.remove();
                        }
                    }
                });

                // Clear selection and update UI
                selectedLinks.clear();
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
                updateUI();

                // Check if all links were deleted
                const remainingLinks = document.querySelectorAll('.link-item').length;
                if (remainingLinks === 0) {
                    // Show no links message
                    linksContainer.innerHTML = '<div class="no-links">No links created yet.</div>';
                    // Hide bulk actions
                    document.querySelector('.bulk-actions').style.display = 'none';
                }

                const failures = results.filter(result => result.status === 'rejected' || !result.value.ok);
                if (failures.length > 0) {
                    alert(`${results.length - failures.length} links deleted successfully. ${failures.length} failed.`);
                } else {
                    alert('All links deleted successfully!');
                }

            } finally {
                spinner.style.display = 'none';
                deleteAllBtn.disabled = false;
            }
        }

        async function deleteSingleLink(linkId) {
            try {
                const response = await fetch(`/admin/delete/${linkId}`, { method: 'DELETE' });

                if (response.ok) {
                    const linkItem = document.querySelector(`[data-link-id="${linkId}"]`);
                    if (linkItem) {
                        linkItem.remove();
                    }

                    // Remove from selected set if it was selected
                    selectedLinks.delete(linkId);
                    updateUI();

                    // Check if this was the last link
                    const remainingLinks = document.querySelectorAll('.link-item').length;
                    if (remainingLinks === 0) {
                        linksContainer.innerHTML = '<div class="no-links">No links created yet.</div>';
                        document.querySelector('.bulk-actions').style.display = 'none';
                    }

                    alert('Link deleted successfully!');
                } else {
                    const errorData = await response.json();
                    alert(`Failed to delete link: ${errorData.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Delete failed:', error);
                alert('Failed to delete link. Please try again.');
            }
        }

        async function editLinkId(oldLinkId, newLinkId) {
            try {
                const response = await fetch(`/admin/edit/${oldLinkId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ new_link_id: newLinkId })
                });

                if (response.ok) {
                    // Update the link item in the DOM
                    const linkItem = document.querySelector(`[data-link-id="${oldLinkId}"]`);
                    if (linkItem) {
                        // Update data attributes
                        linkItem.setAttribute('data-link-id', newLinkId);
                        const checkbox = linkItem.querySelector('.link-checkbox');
                        if (checkbox) {
                            checkbox.setAttribute('data-link-id', newLinkId);
                        }
                        const editBtn = linkItem.querySelector('.edit-btn');
                        if (editBtn) {
                            editBtn.setAttribute('data-link-id', newLinkId);
                        }
                        const deleteBtn = linkItem.querySelector('.delete-btn');
                        if (deleteBtn) {
                            deleteBtn.setAttribute('data-link-id', newLinkId);
                        }

                        // Update the displayed link ID
                        const linkIdElement = linkItem.querySelector('.link-id');
                        if (linkIdElement) {
                            linkIdElement.textContent = newLinkId;
                        }

                        // Update download link
                        const downloadLink = linkItem.querySelector('.link-details a');
                        if (downloadLink) {
                            const newDownloadUrl = `${window.location.protocol}//${window.location.host}/download/${newLinkId}`;
                            downloadLink.href = newDownloadUrl;
                            downloadLink.textContent = newDownloadUrl;
                        }
                    }

                    // Update selected links set if necessary
                    if (selectedLinks.has(oldLinkId)) {
                        selectedLinks.delete(oldLinkId);
                        selectedLinks.add(newLinkId);
                    }

                    alert('Link ID updated successfully!');
                } else {
                    const errorData = await response.json();
                    alert(`Failed to update link ID: ${errorData.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Edit failed:', error);
                alert('Failed to update link ID. Please try again.');
            }
        }
    </script>
</body>
</html>